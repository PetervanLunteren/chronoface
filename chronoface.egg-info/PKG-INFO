Metadata-Version: 2.4
Name: chronoface
Version: 0.1.0
Summary: Chronoface local face clustering and collage generator
Author: Chronoface contributors
License: MIT
Project-URL: Homepage, https://github.com/chronoface/chronoface
Project-URL: Repository, https://github.com/chronoface/chronoface
Keywords: photos,faces,clustering,collage
Classifier: Development Status :: 3 - Alpha
Classifier: Programming Language :: Python :: 3
Classifier: Programming Language :: Python :: 3.11
Classifier: License :: OSI Approved :: MIT License
Classifier: Framework :: FastAPI
Requires-Python: >=3.11
Description-Content-Type: text/markdown
License-File: LICENSE
Requires-Dist: fastapi~=0.110
Requires-Dist: uvicorn[standard]~=0.29
Requires-Dist: opencv-contrib-python~=4.9
Requires-Dist: onnxruntime~=1.17
Requires-Dist: scikit-learn~=1.4
Requires-Dist: pillow>=10.1
Requires-Dist: pillow-heif~=0.16
Requires-Dist: piexif~=1.1
Requires-Dist: imagehash~=4.3
Requires-Dist: pydantic~=2.6
Requires-Dist: python-multipart~=0.0.9
Requires-Dist: loguru~=0.7
Requires-Dist: typer~=0.12
Requires-Dist: numpy<3,>=1.26
Requires-Dist: orjson~=3.10
Provides-Extra: dev
Requires-Dist: ruff~=0.4; extra == "dev"
Requires-Dist: black~=24.4; extra == "dev"
Requires-Dist: mypy~=1.8; extra == "dev"
Requires-Dist: pytest~=8.1; extra == "dev"
Requires-Dist: pytest-asyncio~=0.23; extra == "dev"
Requires-Dist: httpx~=0.27; extra == "dev"
Requires-Dist: respx~=0.20; extra == "dev"
Dynamic: license-file

# Chronoface

Chronoface scans an unsorted folder of photos, detects faces with open source CPU models, clusters
people within time buckets, lets you review every detection, and exports printable collages ‚Äî all on
your machine.

![Chronoface interface placeholder](docs/screenshots/placeholder_scan.png)

## Features

- üß≠ **Time-aware scanning** ‚Äì Reads EXIF `DateTimeOriginal`, skips invalid files, and groups photos
  into day, week, month, or year buckets.
- üòÄ **CPU face pipeline** ‚Äì Uses YuNet for detection and SFace for embeddings with ONNX Runtime on
  the CPU, no GPU required.
- üßπ **Cache & resume** ‚Äì Hash-based cache of thumbnails and embeddings avoids recomputation when you
  rescan the same folder.
- üßë‚Äçüíª **Human-in-the-loop review** ‚Äì Accept or reject faces, merge/split clusters, and track skipped
  images with clear reasons.
- üñºÔ∏è **Collage exporter** ‚Äì Render grid collages per bucket with configurable layout, background,
  tile size, and filters.
- üîå **Local-only** ‚Äì No telemetry or network calls during processing. Works on Windows, macOS, and
  Linux with Python 3.11 and Node 18+.

## Architecture

- **Backend**: FastAPI, Uvicorn, OpenCV, ONNX Runtime, scikit-learn, Pillow, pydantic v2, Typer CLI.
- **Frontend**: React 18, TypeScript, Vite, Tailwind CSS, Radix UI toasts, TanStack Query, Zustand.
- **Communication**: REST endpoints for operations and Server-Sent Events for progress updates.
- **Models**: YuNet detector and SFace recognizer from the OpenCV Zoo (Apache-2.0 licensed).

```
chronoface/
‚îú‚îÄ‚îÄ backend/            # FastAPI service and processing pipeline
‚îú‚îÄ‚îÄ frontend/           # Vite + React SPA
‚îú‚îÄ‚îÄ scripts/            # Helper scripts (dev runner)
‚îî‚îÄ‚îÄ backend/data/       # Sample photos with EXIF metadata
```

## Prerequisites

- Python **3.11**
- Node.js **18** (or newer LTS)
- npm **9** or newer

## Quick start

```bash
# 1. Create and activate a virtualenv, install Python deps (+ dev tooling)
make venv

# 2. Fetch YuNet & SFace ONNX models (downloads from OpenCV Zoo)
make models

# 3. Install frontend deps & start dev servers (backend + frontend)
make dev
```

`make dev` runs Uvicorn with auto-reload on <http://127.0.0.1:8080> and Vite at
<http://127.0.0.1:5173>. The frontend is proxied to talk to the backend at `/api/*`.

## Running manually

Backend only:

```bash
source .venv/bin/activate
uvicorn backend.app:app --reload --host 127.0.0.1 --port 8080
```

Frontend only:

```bash
cd frontend
npm install
npm run dev
```

## Headless CLI usage

```
# Scan a folder and emit collages without the web UI
python -m backend scan /absolute/path/to/photos --bucket month

# Run the API server with explicit host/port
python -m backend serve --host 127.0.0.1 --port 8080
```

All collages and manifests land in the `output/<run-id>/` folder. Temporary caches live in
`.chronoface_cache/<run-id>/`.

## Building for production

```bash
make build
# Copies the Vite build into backend/static/frontend and verifies model checksums
```

The backend serves static assets at `/api/static/*`, including face thumbnails and generated
collages.

## Testing & linting

```bash
make test   # pytest + vitest
make lint   # Ruff, Black, mypy, ESLint
```

Backend acceptance tests cover EXIF parsing, bucketing, clustering, collage math, and error
handling. Frontend tests cover key UI interactions (bucket selection, detection grid selection, and
state updates).

## Configuration

Chronoface reads optional environment variables (or `.env`) with prefix `CHRONOFACE_`:

| Variable | Default | Description |
| --- | --- | --- |
| `CHRONOFACE_HOST` | `127.0.0.1` | Uvicorn bind host |
| `CHRONOFACE_PORT` | `8080` | Uvicorn bind port |
| `CHRONOFACE_OUTPUT_DIR` | `output` | Destination for collages & manifests |
| `CHRONOFACE_CACHE_DIR` | `.chronoface_cache` | Cache for thumbnails & embeddings |
| `CHRONOFACE_STATIC_DIR` | `output/static` | Served static directory |
| `CHRONOFACE_MODEL_DIR` | `backend/models` | Where YuNet/SFace ONNX files live |

## Data flow

1. **Scan** ‚Äì Walk the provided folder recursively, reading EXIF `DateTimeOriginal`. Photos without a
   valid timestamp are skipped and reported.
2. **Detect** ‚Äì Downscale images if requested, run YuNet on the CPU, filter by minimum face size, and
   emit thumbnails + embeddings.
3. **Cluster** ‚Äì Group embeddings per bucket with DBSCAN (cosine distance), assign noise to `noise`.
4. **Review** ‚Äì UI lets you accept/reject faces, merge clusters, or split faces into a new cluster.
5. **Collage** ‚Äì Select faces (accepted only, or include unreviewed) and render a deterministic grid;
   collages are saved inside `output/<run-id>/` and exposed via `/api/static/collages/<file>.png`.

## Sample data

`backend/data/sample_photos/` includes five generated JPEGs with valid EXIF timestamps for quick
smoke-testing. They are simple synthetic faces created specifically for this project and released to
the public domain.

## Third-party notices

See [`backend/models/THIRD_PARTY_NOTICES.md`](backend/models/THIRD_PARTY_NOTICES.md) for model
licenses. Both YuNet and SFace are Apache-2.0 and compatible with the MIT project license.

## Contributing

1. Fork the repo and create a feature branch (`feat/my-change`).
2. Follow the existing formatting rules (`make lint`).
3. Add tests when fixing bugs or adding features.
4. Keep functions small with docstrings describing non-trivial behavior.
5. Submit a PR with a summary of changes and testing performed.

Commit style: `type(scope): short summary` (e.g., `feat(pipeline): support multi-bucket merge`).

## License

Chronoface is released under the [MIT License](LICENSE). Model binaries remain licensed by their
authors.
